---
title: "**Refined moderation Analysis with binary outcomes using Modana**"
author: "Eric Anto"
date: "`r format(Sys.time(), '%A, %B %d, %Y')`"
format: gfm
#bibliography: reference.bib
output: rmarkdown::html_vignette
urlcolor: blue
vignette: >
  %\VignetteIndexEntry{Modana}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
 options(rmarkdown.html_vignette.check_title = FALSE)
```

# Introduction
Moderation analysis for evaluating differential treatment effects serves as the bedrock of precision medicine, which is of growing interest in many fields. In the analysis of data with binary outcomes, we observe an interesting symmetry property concerning the ratio of odds ratios, which suggests that heterogeneous treatment effects could be equivalently estimated via a role exchange between the outcome and treatment variable in logistic regression models. We then obtain refined inference on moderating effects by rearranging data and combining two models into one via a generalized estimating equation approach. The improved efficiency is helpful in addressing the lack-of-power problem that is common in the search for important moderators. We investigate the proposed method by simulation and provide an illustration with data from a randomized trial on wart treatment.

# Getting Started

This `Modana` package implements a refinement of moderation analysis with binary outcomes, as proposed by [Anto and Su (2023)](https://journals.sagepub.com/doi/abs/10.1177/09622802231151206?journalCode=smma). The function fits three models of interest: a direct model, an inverse model, and a generalized estimating equation (GEE) model. The direct and inverse models are fitted using the `glm` function to verify the symmetry property of odds ratio/relative risk in moderation analysis for the main treatment effect as well as the moderating effects. The GEE model is fitted using the `geeglm` function and is used to estimate the treatment effect accounting for within-cluster correlation. The `Modana` package has three different built functions.


# Installing and using the package

```{r setup, warning = FALSE}
install.packages("../Modana_0.1.0.tar.gz", repos = NULL)
library(Modana)
```


# Simulating data
The function `sim_data()` generates simulated data for a randomized controlled trial or an observational study
The function takes several arguments including a formula object, data frame, the name of the binary response and binary treatment column in the data, a vector of potential effect modifiers, and other arguments that are passed to the geeglm function. If effect modifiers are specified, the function fits models with interaction terms between the effect modifiers and the treatment variable.

- `n`	the number of observations to generate.

- `b0`	a vector of coefficients for the linear predictor in the outcome model. The length of `b0` should be equal to the number of covariates plus one (for the intercept term). The first element of `b0` corresponds to the intercept, and the remaining elements correspond to the coefficients for the covariates which may include include interaction coefficients.

- `a0` 	a vector of coefficients for the linear predictor in the treatment assignment model. The length of `a0` should be equal to the number of covariates plus one (for the intercept term). The first element of `a0` corresponds to the intercept, and the remaining elements correspond to the coefficients for the covariates. This argument is only used if 'observational = TRUE'.

- `link.function`	a character string specifying the link function to use in the outcome model. The default is 'logistic', which corresponds to the logistic link function. The other option is 'exp', which corresponds to the log-linear link function.

- `sigma` 	the standard deviation of the covariate distribution. The default value is '1'.

- `uniform`	a logical value indicating whether to transform the covariates to a uniform distribution on the interval '[0, c0]'. The default value is 'FALSE'.

- `c0`	the upper limit of the uniform distribution used to transform the covariates. The default value is 1.

- `binary.Xs`	a logical value indicating whether to change some columns of continuous covariates into binary variables. The default value is 'FALSE'.

- `rho`	the correlation parameter used to generate the covariance matrix. The default value is '0.2'.

- `observational`	 a logical value indicating whether to generate data for an observational study. The default value is FALSE.

- `trt.p`	 the probability of receiving the treatment. This argument is only used if 'observational = FALSE'. The default value is 0.5.

- `interaction`	a vector of indices indicating which covariates should be used to create interaction terms with the treatment variable. The length of interaction should be less than or equal to the number of covariates. The default value is 'NULL', which indicates no interaction terms should be used.

- `details`	a logical value indicating whether to print details about the generated data. The default value is FALSE.

```{r}
set.seed(1099)
b0 <- c(1, 1.2, 1, 1.5, -2, -.5, 1.2, 1.5)
a0 <- c(-1, 1.5, -1, 1.5)
#a0 <- c(-2, 2, 2, 0, 1)
b0 <- c(-1.5, 1.5, 1.5, -2, 2, -.5, -1, 1.5)
 datt <- sim_data(n = 100, b0, a0 = NULL, binary.Xs = FALSE,
                      sigma = 1, uniform = FALSE, c0 = 1,
                      link.function = "logistic", rho = 0.2,
                      observational = FALSE, trt.p = 0.5,
                      interaction = 1:2, details = FALSE)
head(datt)
#compares.plot <- function() 
```

# Building a data structure that mimicks a clustered/longitudinal data 

The main idea of this computing trick is to rearrange the data into a format that mimics a clustered or longitudinal data. This is done by using the `swaparr()` function which performs a role exchange of the response variable and treatment variable columns in the original data and then stacking the resultant data on top of the original data. The function then introduces a dummy variable to distinguish between the direct and inverse models alongside with a cluster `id`. The `swaparr()` function only takes three arguments.

- `data` original data frame containing the variables in the model.
- `y` name of a binary response column in data.
- `trt`	name of a binary treatment column in data.


```{r}
swaparr(data = datt, y = "y", trt = "trt") |> head()
```

# Estimating main treatment and heterogeneous treatment effects
The `refinedmod()` function implements refined moderation analysis to estimate both treatment effect and moderating effects associated with two logistic regression models with binary outcomes/treatment via generalized estimating equations (GEE). 
The function first performs a role swap algorithm on the original data to obtain a clustered data of size `2` (i.e., swapping the roles of the response variable and treatment variable columns in the original data data and then stacking the resultant data on top of the original data). A dummy variable z is introduced to distinguish the two glm models. Three models of interest are fitted using `refinedmod()`, i.e., two glms (for the direct and inverse models) and a combined GEE model. The function has several arguments. It provides the option to include interaction effects between the moderators and the treatment. The function takes a formula, the name of the binary response variable, the name of the binary treatment variable, and the names of the potential effect modifiers as inputs. It returns the estimated coefficients, standard errors, p-values, and confidence intervals for the main treatment effect and moderating effects. The function also provides the option to print summary results for the three models.

- `formula`	an object of class "formula" (or one that can be coerced to that class): a symbolic description of the model to be fitted.
- `data` original data frame containing the variables in the model.
- `y` name of a binary response column in data.
- `trt`	name of a binary treatment column in data.
- `effmod`	a vector of potential effect modifiers used in the data.
- `detail`	a logical argument specified to print summary results of the direct and inverse models.
If the `detail` argument is set to TRUE, the function will print summary results of the direct and inverse models. The function returns an object of type `glm` and `geeglm`, and can be used to extract summary information using the summary function.

```{r}
getres <- refinedmod(formula = y ~ trt + x1 + x2 + x3 + x4,
                     detail = FALSE, y = "y",
                    trt = "trt", data = datt,
                     effmod = c("x1", "x2"),
                      corstr = "independence")
summary(getres$out.combined)
```

The refined estimates of the main treatment and effect modifiers can pulled and compared with both the direct and indirect models.
```{r}
print(getres$comparisonresults)
```

